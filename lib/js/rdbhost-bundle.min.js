!function(e,t){e._={};var n=_.property=function(e){return function(t){return null==t?void 0:t[e]}};_.filter=_.select=function(e,t,n){var r=[];return _.each(e,function(e,n,o){t(e,n,o)&&r.push(e)}),r};var r=Math.pow(2,53)-1,o=n("length"),i=function(e){var t=o(e);return"number"==typeof t&&t>=0&&r>=t};_.isArray=Array.isArray||function(e){return"[object Array]"===toString.call(e)},_.isObject=function(e){var t=typeof e;return"function"===t||"object"===t&&!!e},_.isNumber=function(e){return"[object Number]"===toString.call(e)},_.each=_.forEach=function(e,t){var n,r;if(i(e))for(n=0,r=e.length;r>n;n++)t(e[n],n,e);else{var o=_.keys(e);for(n=0,r=o.length;r>n;n++)t(e[o[n]],o[n],e)}return e};var a=function(e,t){return function(n){var r=arguments.length;if(t&&(n=Object(n)),2>r||null==n)return n;for(var o=1;r>o;o++)for(var i=arguments[o],a=e(i),c=a.length,s=0;c>s;s++){var u=a[s];t&&void 0!==n[u]||(n[u]=i[u])}return n}};_.allKeys=function(e){if(!_.isObject(e))return[];var t=[];for(var n in e)t.push(n);return t},_.extend=a(_.allKeys)}(window),function(e){function t(){var t=e;return"Promise"in t&&"resolve"in t.Promise&&"reject"in t.Promise&&"all"in t.Promise&&"race"in t.Promise&&function(){var e;return new t.Promise(function(t){e=t}),"function"==typeof e}()}function n(){return"fetch"in e}e.Rdbhost=_.extend(e.Rdbhost||{},{featuredetects:{hasPromises:t,hasFetch:n}})}(window),function(e,t){"function"==typeof define&&define.amd?define([],t):"undefined"!=typeof module&&module.exports?module.exports=t():e.ReconnectingWebSocket=t()}(this,function(){function e(t,n,r){function o(e,t){var n;return window.CustomEvent?n=new CustomEvent(e,{detail:t,bubbles:!1,cancelable:!1}):(n=document.createEvent("CustomEvent"),n.initCustomEvent(e,!1,!1,t)),n}var i={debug:!1,automaticOpen:!0,reconnectInterval:1e3,maxReconnectInterval:3e4,reconnectDecay:1.5,timeoutInterval:2e3,maxReconnectAttempts:null,binaryType:"blob"};r||(r={});for(var a in i)"undefined"!=typeof r[a]?this[a]=r[a]:this[a]=i[a];this.url=t,this.reconnectAttempts=0,this.readyState=WebSocket.CONNECTING,this.protocol=null;var c,s=this,u=!1,h=!1,l=document.createElement("div");l.addEventListener("open",function(e){s.onopen(e)}),l.addEventListener("close",function(e){s.onclose(e)}),l.addEventListener("connecting",function(e){s.onconnecting(e)}),l.addEventListener("message",function(e){s.onmessage(e)}),l.addEventListener("error",function(e){s.onerror(e)}),this.addEventListener=l.addEventListener.bind(l),this.removeEventListener=l.removeEventListener.bind(l),this.dispatchEvent=l.dispatchEvent.bind(l),this.open=function(t){if(c=new WebSocket(s.url,n||[]),c.binaryType=this.binaryType,t){if(this.maxReconnectAttempts&&this.reconnectAttempts>this.maxReconnectAttempts)return}else l.dispatchEvent(o("connecting",event)),this.reconnectAttempts=0;(s.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","attempt-connect",s.url);var r=c,i=setTimeout(function(){(s.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","connection-timeout",s.url),h=!0,r.close(),h=!1},s.timeoutInterval);c.onopen=function(n){clearTimeout(i),(s.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","onopen",s.url),s.protocol=c.protocol,s.readyState=WebSocket.OPEN,s.reconnectAttempts=0;var r=o("open",n);r.isReconnect=t,t=!1,l.dispatchEvent(r)},c.onclose=function(n){if(clearTimeout(i),c=null,u)s.readyState=WebSocket.CLOSED,l.dispatchEvent(o("close",n));else{s.readyState=WebSocket.CONNECTING;var r=o("connecting",n);r.code=n.code,r.reason=n.reason,r.wasClean=n.wasClean,l.dispatchEvent(r),t||h||((s.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","onclose",s.url),l.dispatchEvent(o("close",n)));var i=s.reconnectInterval*Math.pow(s.reconnectDecay,s.reconnectAttempts);setTimeout(function(){s.reconnectAttempts++,s.open(!0)},i>s.maxReconnectInterval?s.maxReconnectInterval:i)}},c.onmessage=function(t){(s.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","onmessage",s.url,t.data);var n=o("message",t);n.data=t.data,l.dispatchEvent(n)},c.onerror=function(t){(s.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","onerror",s.url,t),l.dispatchEvent(o("error",t))}},1==this.automaticOpen&&this.open(!1),this.send=function(t){if(c)return(s.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","send",s.url,t),c.send(t);throw"INVALID_STATE_ERR : Pausing to reconnect websocket"},this.close=function(e,t){"undefined"==typeof e&&(e=1e3),u=!0,c&&c.close(e,t)},this.refresh=function(){c&&c.close()}}if("WebSocket"in window)return e.prototype.onopen=function(e){},e.prototype.onclose=function(e){},e.prototype.onconnecting=function(e){},e.prototype.onmessage=function(e){},e.prototype.onerror=function(e){},e.debugAll=!1,e.CONNECTING=WebSocket.CONNECTING,e.OPEN=WebSocket.OPEN,e.CLOSING=WebSocket.CLOSING,e.CLOSED=WebSocket.CLOSED,e}),function(e){function t(){}t.prototype={on:function(e,t,n){var r=this.e||(this.e={});return(r[e]||(r[e]=[])).push({fn:t,ctx:n}),this},once:function(e,t,n){function r(){o.off(e,r),t.apply(n,arguments)}var o=this;return r._=t,this.on(e,r,n)},emit:function(e){var t=[].slice.call(arguments,1),n=((this.e||(this.e={}))[e]||[]).slice(),r=0,o=n.length;for(r;o>r;r++)n[r].fn.apply(n[r].ctx,t);return this},off:function(e,t){var n=this.e||(this.e={}),r=n[e],o=[];if(r&&t)for(var i=0,a=r.length;a>i;i++)r[i].fn!==t&&r[i].fn._!==t&&o.push(r[i]);return o.length?n[e]=o:delete n[e],this}},e.TinyEmitter=t}(window),function(e,t){"use strict";function n(){return new Promise(function(e,t){var n=document.getElementById("RDBHOST-SQL-INLINE-ID");if(!n)return t(new Error("no inline sql found"));try{var r=n.textContent,o=JSON.parse(r)}catch(i){return console.log("handle_inline_sql error "+i.message),t(i)}if("OK"==o.status[1])return e(o);if("rdb10"===o.error[0]){var a=n.getAttribute("data-sql"),c=n.getAttribute("data-role");if("p"===c.substr(0,1)){var s=R().query(a).go();s.then(function(t){e(t)})["catch"](function(e){t(e)})}}else t(new Error(o.error.join(" ")))})}function r(e,t,n){var r=e.querySelector(t);r&&(~t.indexOf("span.")?r.textContent=n||"":r.value=n||"")}function o(e,t,n,o,i,a){var c=r.bind(null,e);c("span.error",t||""),c("span.notice",n||""),c("span.sql",o||""),c("input[name='password']",""),c("input[name='role']",a||""),c("input[name='email']",i||"")}function i(e,t){var n,o=r.bind(null,e),i=(n=e.querySelector("input[name='email']"))?n.value:"",a=(n=e.querySelector("input[name='role']"))?n.value:"",c=(n=e.querySelector("input[name='password']"))?n.value:"";return i.length||a.length?c.length?(i&&(H.email=i),a&&(H.role=a),t([i||a,c]),!0):(o("span.error","provide a password"),!1):(o("span.error","provide an email address"),!1)}function a(e,t){return t(),!0}function c(e,t,n,r,o,i){function a(e){return s.contains(e.target)?!0:(e.stopImmediatePropagation(),e.stopPropagation(),e.preventDefault(),!1)}if(V)return new Promise(function(a,s){M.once(U.formcleared,function(){a(c(e,t,n,r,o,i))})});var s=document.createElement("div");s.innerHTML=n;var u=s.firstElementChild.attributes.id.value,h=s.getElementsByTagName("style")[0];if(h.remove(),document.getElementById(u))throw new Error("Element ~i in dom already".replace("~i",u));return document.body.appendChild(s),document.head.appendChild(h),V=!0,document.body.addEventListener("click",a,!0),new Promise(function(n,c){function l(t){t.stopPropagation(),t.preventDefault(),e(f,n)&&(document.body.removeChild(s),document.head.removeChild(h),document.body.removeEventListener("click",a,!0),V=!1,M.emit(U.formcleared,i))}function d(e){e.stopPropagation(),e.preventDefault(),document.body.removeChild(s),document.head.removeChild(h),document.body.removeEventListener("click",a,!0),V=!1,M.emit(U.formcleared,i),c(new Error("authorization dialog cancelled"))}var f=document.getElementById(u);t(f,r,i,o,H.email,H.role),f.querySelector("form").addEventListener("submit",l),f.querySelector(".cancel").addEventListener("click",d)})}function s(e,t){var n="000000000"+t;return e.substr(0,1).toLowerCase()+n.substr(n.length-10,10)}function u(e,t){function n(e){delete r[e],delete r[e+"_to"]}var r=ee.authorization_cache;e+"_to"in r&&n(e);var o=setTimeout(function(){n(e)},27e5);t?(r[e]=t,r[e+"_to"]=o):n(e)}function h(e,t,n){var r=t&&_.isNumber(t);D=r?e:"www.rdbhost.com",z=r?t:e,W=(r?n:t)||"//"+D+"/vendor/rdbhost/2.0/lib/partials/"}function l(e){if(!z)throw new Error("account not set with connect method");if(Q[e])throw new Error("connection already established for "+e);var t=s(e,z),n=!1;return Q[e]=new ReconnectingWebSocket("wss://"+D+"/wsdb/"+t,null,{debug:B}),Q[e].onopen=function(){n=!0,M.emit(U.connectionmade,e,z),M.emit(U.connectionmade+":"+e,e,z)},Q[e].onclose=function(){M.emit(U.connectionclosed,e,z),M.emit(U.connectionclosed+":"+e,e,z)},Q[e].onerror=function(){n?(M.emit(U.connectionerror,e,z),M.emit(U.connectionerror+":"+e,e,z)):M.emit(U.connectionopenfail,e,z)},Q[e].onmessage=function(t){f(e,t.data)},Q[e]}function d(e,t){for(var n in Q)Q.hasOwnProperty(n)&&(Q[n].close(e,t),delete Q[n]);ee.authorization_cache={}}function f(e,t){var n,r,o,i=JSON.parse(t),a=i["request-id"],c=J[a];if(a&&e!==a.substr(0,e.length))throw new Error("inconsistency between role ~r and reqId ~i".replace("~r",e).replace("~i",a));if(c)n=c[0],r=c[1],o=c[2],"error"===i.status[0]?(p(i.error),r(new Error("error ~1 ~2".replace("~1",i.error[0]).replace("~2",i.error[1])))):(_.each(o.result_hooks,function(e){e(i)}),n(Promise.resolve(i))),delete J[a];else if(a)console.log("Bad message request-id "+a);else if("notify"===i.status[0]){var s=i.payload,u=i.channel;"rdbhost_ftp_channel"===u.substr(0,19)?(M.emit(U.reloadrequest,u,s),M.emit(U.reloadrequest+":"+u,u,s)):(M.emit(U.notifyreceived,u,s),M.emit(U.notifyreceived+":"+u,u,s))}else"keep-alive"===i.status[0]&&console.log("keep-alive received")}function p(e){var t=e[0],n=e[1];M.emit(U.databaseerror,t,n),M.emit(U.databaseerror+":"+t,t,n),M.emit(U.databaseerror+":"+t.substr(0,2),t,n)}function m(e){if(!e.result_sets&&e.records){var t=e.records;e.result_sets=[t],delete e.records}}function b(e){var t=e.result_sets;if(t.length<2)throw new Error("invalid result set collection provided to strip_listen");t.splice(0,1),t.splice(t.length-2,2)}function v(e,t,n,r){var a=this,s=q(e+"_auth");return s.then(function(e){return c(i,o,e,t,n,r)})["catch"](function(e){throw e}).then(function(t){var o=t[0],i=t[1],c="auth"===e?k(acct_number,e,i):C(acct_number,o,i);return c["catch"](function(t){if("bad input. "===t.message.substr(0,11))return v.call(a,e,"fix input",n,r);if("bad email/p"===t.message.substr(0,11))return v.call(a,e,"bad email/pass combo",n,r);throw t})})}function g(){if(this.request_hooks.length&&this.repeatCt&&this.repeatCt>1){var e=_.filter(this.request_hooks,function(e){return"listen"===e.label});if(e.length)throw new Error("listen and repeat cannot be used on same request")}var t=this;_.each(this.request_hooks,function(e){e(t)})}function w(){g.call(this);var e=this.formData;e.append("q",this.qPlus||this.q),delete this.qPlus,this.hasOwnProperty("repeatCt")&&e.append("repeat",this.repeatCt),this.hasOwnProperty("mode")&&e.append("mode",this.mode),"super"===this.role&&this.authorization_cache["super"]&&e.append("authcode",this.authorization_cache["super"]),"preauth"===this.role&&this.authorization_cache.preauth&&e.append("super-authcode",this.authorization_cache.preauth),"auth"===this.role&&this.authorization_cache.preauth&&(e.append("super-authcode",this.authorization_cache.preauth),e.append("authcode",this.authorization_cache.auth)),e.append("format","json-easy");var t=s(this.role,z),n="https://"+D+"/db/"+t;return[n,e]}function y(){g.call(this);var e={q:this.qPlus||this.q,args:this.args,namedParams:this.namedParams,"request-id":this.reqId};return delete this.qPlus,this.hasOwnProperty("repeatCt")&&(e.repeat=this.repeatCt),this.hasOwnProperty("mode")&&(e.mode=this.mode),"super"===this.role?e.authcode=this.authorization_cache["super"]:"preauth"===this.role?(e["super-authcode"]=this.authorization_cache.preauth,e.authcode="-"):"auth"===this.role&&(e["super-authcode"]=this.authorization_cache.preauth,e.authcode=this.authorization_cache.auth),JSON.stringify(e)}function E(){return"super"===this.role?!!this.authorization_cache["super"]:"preauth"===this.role?!!this.authorization_cache.preauth:"auth"===this.role?!(!this.authorization_cache.preauth||!this.authorization_cache.auth):!1}function q(e){if(e in K)return Promise.resolve(K[e]);var t=W+e+".tpl.html",n=fetch(t);return n.then(function(n){if(!n.ok)throw new Error("page ~p not found.".replace("~p",t));var r=n.text();return r.then(function(t){return K[e]=t,K[e]})},function(e){throw e})}function S(e){var t=this;return new Promise(function(n,r){var o=e.call(t),i=o[0],a=o[1],c=fetch(i,{method:"post",body:a});c.then(function(e){if(e.ok){var o=e.json();o.then(function(e){"error"===e.status[0]?(p(e.error),r(new Error("error ~1 ~2".replace("~1",e.error[0]).replace("~2",e.error[1])))):(_.each(t.result_hooks,function(t){t(e)}),n(e))})}else r(new Error("Status: "+e.status+" "+e.statusText))})["catch"](function(e){r(e)})})}function O(e){function t(){var t=e.call(n);return new Promise(function(e,r){n.conn.send(t),J[n.reqId]=[e,r,n]})}var n=this;return Q[n.role]&&Q[n.role].readyState===Y.OPEN?t():new Promise(function(e,r){M.once(U.connectionmade+":"+n.role,function(){e(t())})})}function P(e,t){function n(){if(!r.q)throw new Error("no query was provided");if(r.isDone)throw new Error("request has already been run. use clone to rerun it.");return r.formData?e.call(r):t.call(r)}var r=this;if(Rdbhost.paranoid_confirm&&E.call(this)){var i=q(r.role+"_confirm");return i.then(function(e){return c(a,o,e,"",r.q,"")})["catch"](function(e){throw e}).then(function(){return n()})}return n()}function C(e, t, n){var r="https://"+D+"/acct/login/0"+s("reader",e).substr(1),o=new FormData;o.append("arg:email",t),o.append("arg:password",n);var i=fetch(r,{method:"post",body:o});return i.then(function(e){return e.json().then(function(e){if(e.error)throw new Error(e.error[1]);for(var t in e.records.rows){var n=e.records.rows[t];if("s"===n.role.substr(0,1))return n}throw new Error("super not found in login records")})})}function k(e,t,n){var r=s("auth",e),o="https://"+D+"/acct/authlogin/0"+r.substr(1),i=new FormData;i.append("arg:role",r),i.append("arg:password",n);var a=fetch(o,{method:"post",body:i});return a.then(function(e){return e.json().then(function(e){if(e.error)throw new Error(e.error[1]);for(var t in e.records.rows){var n=e.records.rows[t];if("a"===n.role.substr(0,1))return n}throw new Error("auth not found in login records")})})}function N(e,t){var n=this,r=e.call(n,t);return r["catch"](function(r){if("error rdb12"===r.message.substr(0,11))return X.call(n,n.q,"Approve Super Query").then(function(r){return u("super",r.authcode),e.call(n,t)});throw r})}function A(e,t){return e.call(this,t)}function I(e,t){var n=this,r=e.call(n,t);return r["catch"](function(r){if("error rdb10"===r.message.substr(0,11))return Z.call(n,n.q,"Authorize Whitelisting of Query").then(function(r){return u("preauth",r.authcode),e.call(n,t)});throw r})}function L(e,t){var n=this,r=e.call(n,t);return r["catch"](function(r){if("error rdb12"===r.message.substr(0,11))return $.call(n,n.q,"Approve Auth Query").then(function(r){return u("auth",r.authcode),e.call(n,t)})["catch"](function(r){if("error rdb10"===r.message.substr(0,11))return Z.call(n,n.q,"Authorize Whitelisting of Query").then(function(r){return u("preauth",r.authcode),e.call(n,t)});throw r});throw r})}function R(){var e=Object.create(ee),t=I.bind(e,O,y),n=I.bind(e,S,w);return e.go=P.bind(e,n,t),e.init("preauth")}function j(e){var t=Object.create(ee),n=L.bind(t,O,y),r=L.bind(t,S,w);return t.go=P.bind(t,r,n),e&&u("auth",e),t.init("auth")}function x(e){var t=Object.create(ee),n=N.bind(t,O,y),r=N.bind(t,S,w);return t.go=P.bind(t,r,n),e&&u("super",e),t.init("super")}function T(){var e=Object.create(ee),t=A.bind(e,O,y),n=A.bind(e,S,w);return e.go=P.bind(e,n,t),e.init("reader")}var D,z,W,G="2.0.0",B=!0,M=new TinyEmitter,Q={},F=1,J={},K={},H={},V=!1,Y={CONNECTING:0,OPEN:1,CLOSING:2,CLOSED:3},U={connectionmade:"connection-opened",connectionclosed:"connection-closed",connectionerror:"connection-error",connectionopenfail:"connection-open-failed",databaseerror:"database-error",notifyreceived:"notify-received",reloadrequest:"reload-request",formcleared:"form-cleared"},X=function(e,t){return v.call(this,"super","",e,t)},Z=function(e,t){return v.call(this,"preauth","",e,t)},$=function(e,t){return v.call(this,"auth","",e,t)},ee={authorization_cache:{},conn:t,init:function(e){if(["preauth","auth","reader","super"].indexOf(e)<0)throw new Error("invalid role "+e+" provided to init");return this.role=e,this.reqId=e+F++,this.isDone=!1,this.conn=Q[e]||l(e),this.result_hooks=[m],this.request_hooks=[],this},proxy:function(e){return this.mode=e,this},query:function(e){return this.q=e,this},params:function(e,t){if(delete this.args,delete this.namedParams,!e&&!t)return this;if("object"!=typeof e)throw new Error("params must be object or array");if(t&&"object"!=typeof t)throw new Error("params must be object or array");if(this.formData)throw new Error("params and FormData cannot be used both in one request");if("number"==typeof e.length?this.args=e:this.namedParams=e,t)if("number"==typeof t.length){if("args"in this)throw new Error("two arrays were provided to params");this.args=t}else{if("namedParams"in this)throw new Error("two objects were provided to params");this.namedParams=t}return this},form_data:function(e){if(this.hasOwnProperty("args")&&this.args.length>0||this.hasOwnProperty("namedParams")&&Object.keys(this.namedParams).length>0)throw new Error("formData cannot be combined with params in same request.");return this.formData=e,this},listen:function(e){if(e.indexOf('"')>-1)throw new Error("channel name cannot include quotes");var t=function(t){var n=['LISTEN "~1"'.replace("~1",e),t.q,"COMMIT; BEGIN;"];t.qPlus=n.join(";\n")};return t.label="listen",this.request_hooks.push(t),this.result_hooks.push(b),this},repeat:function(e){try{e=Number(e)}catch(t){throw new Error("provide number value to repeat method.")}return this.repeatCt=1,e>1&&(this.repeatCt=e),this},clone:function(){var e=Rdbhost[this.role]();for(var t in this)!this.hasOwnProperty(t)||["reqId","conn","role","isDone","qPlus"].indexOf(t)>=0||"function"==typeof this[t]||(_.isArray(this[t])?e[t]=this[t].slice(0):_.isObject(this[t])?e[t]=_.extend({},this[t]):e[t]=this[t]);return e}};M.on(U.connectionopenfail,function(t){fetch("http://"+D+"/acct/corstest/"+z).then(function(t){t.json().then(function(t){"not-ok"===t.status?(console.log("This origin ("+e.location.origin+") is not a CORS-allowed origin for account "+z+"."),console.log("Allowed origins (obscured) are "+t.origins.join(", "))):console.log("Your connection failed, but your domain is CORS-allowed.")})})}),e.Rdbhost=_.extend(e.Rdbhost||{},{on:M.on.bind(M),off:M.off.bind(M),once:M.once.bind(M),connect:h,disconnect:d,preauth:R,auth:j,"super":x,reader:T,inline_sql:n,version:G,paranoid_confirm:!1})}(window);