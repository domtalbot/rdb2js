!function(e,t){e._={};var n=_.property=function(e){return function(t){return null==t?void 0:t[e]}};_.filter=_.select=function(e,t,n){var r=[];return _.each(e,function(e,n,o){t(e,n,o)&&r.push(e)}),r};var r=Math.pow(2,53)-1,o=n("length"),i=function(e){var t=o(e);return"number"==typeof t&&t>=0&&r>=t};_.isArray=Array.isArray||function(e){return"[object Array]"===toString.call(e)},_.isObject=function(e){var t=typeof e;return"function"===t||"object"===t&&!!e},_.each=_.forEach=function(e,t){var n,r;if(i(e))for(n=0,r=e.length;r>n;n++)t(e[n],n,e);else{var o=_.keys(e);for(n=0,r=o.length;r>n;n++)t(e[o[n]],o[n],e)}return e};var a=function(e,t){return function(n){var r=arguments.length;if(t&&(n=Object(n)),2>r||null==n)return n;for(var o=1;r>o;o++)for(var i=arguments[o],a=e(i),s=a.length,c=0;s>c;c++){var u=a[c];t&&void 0!==n[u]||(n[u]=i[u])}return n}};_.isObject=function(e){var t=typeof e;return"function"===t||"object"===t&&!!e},_.allKeys=function(e){if(!_.isObject(e))return[];var t=[];for(var n in e)t.push(n);return t},_.extend=a(_.allKeys)}(window),function(e,t){"function"==typeof define&&define.amd?define([],t):"undefined"!=typeof module&&module.exports?module.exports=t():e.ReconnectingWebSocket=t()}(this,function(){function e(t,n,r){function o(e,t){var n=document.createEvent("CustomEvent");return n.initCustomEvent(e,!1,!1,t),n}var i={debug:!1,automaticOpen:!0,reconnectInterval:1e3,maxReconnectInterval:3e4,reconnectDecay:1.5,timeoutInterval:2e3,maxReconnectAttempts:null,binaryType:"blob"};r||(r={});for(var a in i)"undefined"!=typeof r[a]?this[a]=r[a]:this[a]=i[a];this.url=t,this.reconnectAttempts=0,this.readyState=WebSocket.CONNECTING,this.protocol=null;var s,c=this,u=!1,h=!1,l=document.createElement("div");l.addEventListener("open",function(e){c.onopen(e)}),l.addEventListener("close",function(e){c.onclose(e)}),l.addEventListener("connecting",function(e){c.onconnecting(e)}),l.addEventListener("message",function(e){c.onmessage(e)}),l.addEventListener("error",function(e){c.onerror(e)}),this.addEventListener=l.addEventListener.bind(l),this.removeEventListener=l.removeEventListener.bind(l),this.dispatchEvent=l.dispatchEvent.bind(l),this.open=function(t){if(s=new WebSocket(c.url,n||[]),s.binaryType=this.binaryType,t){if(this.maxReconnectAttempts&&this.reconnectAttempts>this.maxReconnectAttempts)return}else l.dispatchEvent(o("connecting")),this.reconnectAttempts=0;(c.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","attempt-connect",c.url);var r=s,i=setTimeout(function(){(c.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","connection-timeout",c.url),h=!0,r.close(),h=!1},c.timeoutInterval);s.onopen=function(n){clearTimeout(i),(c.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","onopen",c.url),c.protocol=s.protocol,c.readyState=WebSocket.OPEN,c.reconnectAttempts=0;var r=o("open");r.isReconnect=t,t=!1,l.dispatchEvent(r)},s.onclose=function(n){if(clearTimeout(i),s=null,u)c.readyState=WebSocket.CLOSED,l.dispatchEvent(o("close"));else{c.readyState=WebSocket.CONNECTING;var r=o("connecting");r.code=n.code,r.reason=n.reason,r.wasClean=n.wasClean,l.dispatchEvent(r),t||h||((c.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","onclose",c.url),l.dispatchEvent(o("close")));var i=c.reconnectInterval*Math.pow(c.reconnectDecay,c.reconnectAttempts);setTimeout(function(){c.reconnectAttempts++,c.open(!0)},i>c.maxReconnectInterval?c.maxReconnectInterval:i)}},s.onmessage=function(t){(c.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","onmessage",c.url,t.data);var n=o("message");n.data=t.data,l.dispatchEvent(n)},s.onerror=function(t){(c.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","onerror",c.url,t),l.dispatchEvent(o("error"))}},1==this.automaticOpen&&this.open(!1),this.send=function(t){if(s)return(c.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","send",c.url,t),s.send(t);throw"INVALID_STATE_ERR : Pausing to reconnect websocket"},this.close=function(e,t){"undefined"==typeof e&&(e=1e3),u=!0,s&&s.close(e,t)},this.refresh=function(){s&&s.close()}}if("WebSocket"in window)return e.prototype.onopen=function(e){},e.prototype.onclose=function(e){},e.prototype.onconnecting=function(e){},e.prototype.onmessage=function(e){},e.prototype.onerror=function(e){},e.debugAll=!1,e.CONNECTING=WebSocket.CONNECTING,e.OPEN=WebSocket.OPEN,e.CLOSING=WebSocket.CLOSING,e.CLOSED=WebSocket.CLOSED,e}),function(e){function t(){}t.prototype={on:function(e,t,n){var r=this.e||(this.e={});return(r[e]||(r[e]=[])).push({fn:t,ctx:n}),this},once:function(e,t,n){function r(){o.off(e,r),t.apply(n,arguments)}var o=this;return r._=t,this.on(e,r,n)},emit:function(e){var t=[].slice.call(arguments,1),n=((this.e||(this.e={}))[e]||[]).slice(),r=0,o=n.length;for(r;o>r;r++)n[r].fn.apply(n[r].ctx,t);return this},off:function(e,t){var n=this.e||(this.e={}),r=n[e],o=[];if(r&&t)for(var i=0,a=r.length;a>i;i++)r[i].fn!==t&&r[i].fn._!==t&&o.push(r[i]);return o.length?n[e]=o:delete n[e],this}},e.TinyEmitter=t}(window),function(e,t){"use strict";function n(){return new Promise(function(e,t){var n=document.getElementById("RDBHOST-SQL-INLINE-ID");if(!n)return t(new Error("no inline sql found"));try{var r=n.textContent,o=JSON.parse(r)}catch(i){return console.log("handle_inline_sql error "+i.message),t(i)}if("OK"==o.status[1])return e(o);if("rdb10"===o.error[0]){var a=n.getAttribute("data-sql"),s=n.getAttribute("data-role");if("p"===s.substr(0,1)){var c=k().query(a).go();c.then(function(t){e(t)})["catch"](function(e){t(e)})}}else t(new Error(o.error.join(" ")))})}function r(e,t,n,o){if(M)return new Promise(function(i,a){R.once(J.formcleared,function(){i(r(e,t,n,o))})});var i=document.createElement("div");i.innerHTML=e;var a=i.firstElementChild.attributes.id.value;return document.getElementById(a)||document.body.appendChild(i),M=!0,new Promise(function(e,r){function s(e,t){var n=h.querySelector(e);n&&(~e.indexOf("span.")?n.textContent=t||"":n.value=t||"")}function c(t){var n;t.stopPropagation(),t.preventDefault();var r=(n=h.querySelector("input[name='email']"))?n.value:"",a=(n=h.querySelector("input[name='role']"))?n.value:"",c=(n=h.querySelector("input[name='password']"))?n.value:"";r.length||a.length?c.length?(document.body.removeChild(i),r&&(B.email=r),a&&(B.role=a),e([r||a,c]),M=!1,R.emit(J.formcleared,o)):s("span.error","provide a password"):s("span.error","provide an email address")}function u(e){e.stopPropagation(),e.preventDefault(),document.body.removeChild(i),r(new Error("authorization dialog cancelled")),M=!1,R.emit(J.formcleared,o)}var h=document.getElementById(a);s("span.error",t||""),s("span.notice",o||""),s("span.sql",n||""),s("input[name='email']",B.email||""),s("input[name='password']",""),s("input[name='role']",B.role||""),h.querySelector("form").addEventListener("submit",c),h.querySelector(".cancel").addEventListener("click",u)})}function o(e,t){var n="000000000"+t;return e.substr(0,1).toLowerCase()+n.substr(n.length-10,10)}function i(e,t){function n(e){delete r[e],delete r[e+"_to"]}var r=V.authorization_cache;e+"_to"in r&&n(e);var o=setTimeout(function(){n(e)},27e5);t?(r[e]=t,r[e+"_to"]=o):n(e)}function a(e,t){j=t?e:"www.rdbhost.com",L=t?t:e,x="//"+j+"/vendor/rdbhost/2.0/lib/partials/"}function s(e){if(!L)throw new Error("account not set with connect method");if(T[e])throw new Error("connection already established for "+e);var t=o(e,L);return T[e]=new ReconnectingWebSocket("wss://"+j+"/wsdb/"+t,null,{debug:!0}),T[e].onopen=function(){R.emit(J.connectionmade,e,L),R.emit(J.connectionmade+":"+e,e,L)},T[e].onclose=function(){R.emit(J.connectionclosed,e,L),R.emit(J.connectionclosed+":"+e,e,L)},T[e].onerror=function(){R.emit(J.connectionerror,e,L),R.emit(J.connectionerror+":"+e,e,L)},T[e].onmessage=function(t){u(e,t.data)},T[e]}function c(e,t){for(var n in T)T.hasOwnProperty(n)&&(T[n].close(e,t),delete T[n]);V.authorization_cache={}}function u(e,t){var n,r,o,i=JSON.parse(t),a=i["request-id"],s=z[a];if(a&&e!==a.substr(0,e.length))throw new Error("inconsistency between role ~r and reqId ~i".replace("~r",e).replace("~i",a));if(s)n=s[0],r=s[1],o=s[2],"error"===i.status[0]?(h(i.error),r(new Error("error ~1 ~2".replace("~1",i.error[0]).replace("~2",i.error[1])))):(_.each(o.result_hooks,function(e){e(i)}),n(Promise.resolve(i))),delete z[a];else if(a)console.log("Bad message request-id "+a);else if("notify"===i.status[0]){var c=i.payload,u=i.channel;"rdbhost_ftp_channel"===u.substr(0,19)?(R.emit(J.reloadrequest,u,c),R.emit(J.reloadrequest+":"+u,u,c)):(R.emit(J.notifyreceived,u,c),R.emit(J.notifyreceived+":"+u,u,c))}}function h(e){var t=e[0],n=e[1];R.emit(J.databaseerror,t,n),R.emit(J.databaseerror+":"+t,t,n),R.emit(J.databaseerror+":"+t.substr(0,2),t,n)}function l(e){if(!e.result_sets&&e.records){var t=e.records;e.result_sets=[t],delete e.records}}function d(e){var t=e.result_sets;if(t.length<2)throw new Error("invalid result set collection provided to strip_listen");t.splice(0,1),t.splice(t.length-2,2)}function f(e,t,n){var o=this,i=v(e+"_auth");return i.then(function(e){return r(e,t,null,n)})["catch"](function(e){throw e}).then(function(t){var r=t[0],i=t[1],a="auth"===e?q(acct_number,e,i):E(acct_number,r,i);return a["catch"](function(t){if("bad input. "===t.message.substr(0,11))return f.call(o,e,"fix input",n);if("bad email/p"===t.message.substr(0,11))return f.call(o,e,"bad email/pass combo",n);throw t})})}function p(){if(this.request_hooks.length&&this.repeatCt&&this.repeatCt>1){var e=_.filter(this.request_hooks,function(e){return"listen"===e.label});if(e.length)throw new Error("listen and repeat cannot be used on same request")}var t=this;_.each(this.request_hooks,function(e){e(t)})}function m(){p.call(this);var e=this.formData;e.append("q",this.qPlus||this.q),delete this.qPlus,this.hasOwnProperty("repeatCt")&&e.append("repeat",this.repeatCt),this.hasOwnProperty("mode")&&e.append("mode",this.mode),"super"===this.role&&this.authorization_cache["super"]&&e.append("authcode",this.authorization_cache["super"]),"preauth"===this.role&&this.authorization_cache.preauth&&e.append("super-authcode",this.authorization_cache.preauth),e.append("format","json-easy");var t=o(this.role,L),n="https://"+j+"/db/"+t;return[n,e]}function b(){p.call(this);var e={q:this.qPlus||this.q,args:this.args,namedParams:this.namedParams,"request-id":this.reqId};return delete this.qPlus,this.hasOwnProperty("repeatCt")&&(e.repeat=this.repeatCt),this.hasOwnProperty("mode")&&(e.mode=this.mode),"super"===this.role?e.authcode=this.authorization_cache["super"]:"preauth"===this.role?(e["super-authcode"]=this.authorization_cache.preauth,e.authcode="-"):"auth"===this.role&&(e["super-authcode"]=this.authorization_cache.preauth,e.authcode=this.authorization_cache.auth),JSON.stringify(e)}function v(e){if(e in G)return Promise.resolve(G[e]);var t=x+e+".tpl.html",n=fetch(t);return n.then(function(n){if(!n.ok)throw new Error("page ~p not found.".replace("~p",t));var r=n.text();return r.then(function(t){return G[e]=t,G[e]})},function(e){throw e})}function g(e){var t=this;return new Promise(function(n,r){var o=e.call(t),i=o[0],a=o[1],s=fetch(i,{method:"post",body:a});s.then(function(e){if(e.ok){var o=e.json();o.then(function(e){"error"===e.status[0]?(h(e.error),r(new Error("error ~1 ~2".replace("~1",e.error[0]).replace("~2",e.error[1])))):(_.each(t.result_hooks,function(t){t(e)}),n(e))})}else r(new Error("Status: "+e.status+" "+e.statusText))})["catch"](function(e){r(e)})})}function w(e){function t(){var t=e.call(n);return new Promise(function(e,r){n.conn.send(t),z[n.reqId]=[e,r,n]})}var n=this;return T[n.role]&&T[n.role].readyState===F.OPEN?t():new Promise(function(e,r){R.once(J.connectionmade+":"+n.role,function(){e(t())})})}function y(e,t){if(!this.q)throw new Error("no query was provided");if(this.isDone)throw new Error("request has already been run. use clone to rerun it.");return this.formData?e.call(this):t.call(this)}function E(e,t,n){var r="https://"+j+"/acct/login/0"+o("reader",e).substr(1),i=new FormData;i.append("arg:email",t),i.append("arg:password",n);var a=fetch(r,{method:"post",body:i});return a.then(function(e){return e.json().then(function(e){if(e.error)throw new Error(e.error[1]);for(var t in e.records.rows){var n=e.records.rows[t];if("s"===n.role.substr(0,1))return n}throw new Error("super not found in login records")})})}function q(e,t,n){var r=o("auth",e),i="https://"+j+"/acct/authlogin/0"+r.substr(1),a=new FormData;a.append("arg:role",r),a.append("arg:password",n);var s=fetch(i,{method:"post",body:a});return s.then(function(e){return e.json().then(function(e){if(e.error)throw new Error(e.error[1]);for(var t in e.records.rows){var n=e.records.rows[t];if("a"===n.role.substr(0,1))return n}throw new Error("auth not found in login records")})})}function O(e,t){var n=this,r=e.call(n,t);return r["catch"](function(r){if("error rdb12"===r.message.substr(0,11))return K.call(n).then(function(r){return i("super",r.authcode),e.call(n,t)});throw r})}function S(e,t){return e.call(this,t)}function P(e,t){var n=this,r=e.call(n,t);return r["catch"](function(r){if("error rdb10"===r.message.substr(0,11))return H.call(n,"").then(function(r){return i("preauth",r.authcode),e.call(n,t)});throw r})}function C(e,t){var n=this,r=e.call(n,t);return r["catch"](function(r){if("error rdb12"===r.message.substr(0,11))return Q.call(n).then(function(r){return i("auth",r.authcode),e.call(n,t)})["catch"](function(r){if("error rdb10"===r.message.substr(0,11))return H.call(n,"").then(function(r){return i("preauth",r.authcode),e.call(n,t)});throw r});throw r})}function k(){var e=Object.create(V),t=P.bind(e,w,b),n=P.bind(e,g,m);return e.go=y.bind(e,n,t),e.init("preauth")}function N(e){var t=Object.create(V),n=C.bind(t,w,b),r=C.bind(t,g,m);return t.go=y.bind(t,r,n),e&&i("auth",e),t.init("auth")}function I(e){var t=Object.create(V),n=O.bind(t,w,b),r=O.bind(t,g,m);return t.go=y.bind(t,r,n),e&&i("super",e),t.init("super")}function A(){var e=Object.create(V),t=S.bind(e,w,b),n=S.bind(e,g,m);return e.go=y.bind(e,n,t),e.init("reader")}var j,L,x,D="2.0.0",R=new TinyEmitter,T={},W=1,z={},G={},B={},M=!1,F={CONNECTING:0,OPEN:1,CLOSING:2,CLOSED:3},J={connectionmade:"connection-opened",connectionclosed:"connection-closed",connectionerror:"connection-error",databaseerror:"database-error",notifyreceived:"notify-received",reloadrequest:"reload-request",formcleared:"form-cleared"},K=function(e,t){return f.call(this,"super",e,t)},H=function(e,t){return f.call(this,"preauth",e,t)},Q=function(e,t){return f.call(this,"auth",e,t)},V={authorization_cache:{},conn:t,init:function(e){if(["preauth","auth","reader","super"].indexOf(e)<0)throw new Error("invalid role "+e+" provided to init");return this.role=e,this.reqId=e+W++,this.isDone=!1,this.conn=T[e]||s(e),this.result_hooks=[l],this.request_hooks=[],this},proxy:function(e){return this.mode=e,this},query:function(e){return this.q=e,this},params:function(e,t){if(delete this.args,delete this.namedParams,"object"!=typeof e)throw new Error("params must be object or array");if(t&&"object"!=typeof t)throw new Error("params must be object or array");if(this.formData)throw new Error("params and FormData cannot be used both in one request");if("number"==typeof e.length?this.args=e:this.namedParams=e,t)if("number"==typeof t.length){if("args"in this)throw new Error("two arrays were provided to params");this.args=t}else{if("namedParams"in this)throw new Error("two objects were provided to params");this.namedParams=t}return this},form_data:function(e){if(this.hasOwnProperty("args")&&this.args.length>0||this.hasOwnProperty("namedParams")&&Object.keys(this.namedParams).length>0)throw new Error("formData cannot be combined with params in same request.");return this.formData=e,this},listen:function(e){if(e.indexOf('"')>-1)throw new Error("channel name cannot include quotes");var t=function(t){var n=['LISTEN "~1"'.replace("~1",e),t.q,"COMMIT; BEGIN;"];t.qPlus=n.join(";\n")};return t.label="listen",this.request_hooks.push(t),this.result_hooks.push(d),this},repeat:function(e){try{e=Number(e)}catch(t){throw new Error("provide number value to repeat method.")}return e>1&&(this.repeatCt=e),this},clone:function(){var e=Rdbhost[this.role]();for(var t in this)!this.hasOwnProperty(t)||["reqId","conn","role","isDone","qPlus"].indexOf(t)>=0||"function"==typeof this[t]||(_.isArray(this[t])?e[t]=this[t].slice(0):_.isObject(this[t])?e[t]=_.extend({},this[t]):e[t]=this[t]);return e}};e.Rdbhost=_.extend(e.Rdbhost||{},{on:R.on.bind(R),off:R.off.bind(R),once:R.once.bind(R),connect:a,disconnect:c,preauth:k,auth:N,"super":I,reader:A,inline_sql:n,version:D})}(window);