!function(e,t){function n(e){return function(t,n){for(var r=a(t),o=e>0?0:r-1;o>=0&&r>o;o+=e)if(n(t[o],o,t))return o;return-1}}e._={};var r={}.toString,o=_.property=function(e){return function(t){return null==t?void 0:t[e]}};_.filter=_.select=function(e,t,n){var r=[];return _.each(e,function(e,n,o){t(e,n,o)&&r.push(e)}),r};var i=Math.pow(2,53)-1,a=o("length"),s=function(e){var t=a(e);return"number"==typeof t&&t>=0&&i>=t};_.isArray=Array.isArray||function(e){return"[object Array]"===r.call(e)},_.isObject=function(e){var t=typeof e;return"function"===t||"object"===t&&!!e},_.isNumber=function(e){return"[object Number]"===r.call(e)},_.each=_.forEach=function(e,t){var n,r;if(s(e))for(n=0,r=e.length;r>n;n++)t(e[n],n,e);else{var o=_.keys(e);for(n=0,r=o.length;r>n;n++)t(e[o[n]],o[n],e)}return e};var c=function(e,t){return function(n){var r=arguments.length;if(t&&(n=Object(n)),2>r||null==n)return n;for(var o=1;r>o;o++)for(var i=arguments[o],a=e(i),s=a.length,c=0;s>c;c++){var u=a[c];t&&void 0!==n[u]||(n[u]=i[u])}return n}};_.allKeys=function(e){if(!_.isObject(e))return[];var t=[];for(var n in e)t.push(n);return t},_.extend=c(_.allKeys),_.findIndex=n(1),_.findLastIndex=n(-1)}(window),function(e){function t(){var t=e;return"Promise"in t&&"resolve"in t.Promise&&"reject"in t.Promise&&"all"in t.Promise&&"race"in t.Promise&&function(){var e;return new t.Promise(function(t){e=t}),"function"==typeof e}()}function n(){return"fetch"in e}e.Rdbhost=_.extend(e.Rdbhost||{},{featuredetects:{hasPromises:t,hasFetch:n}})}(window),function(e,t){"function"==typeof define&&define.amd?define([],t):"undefined"!=typeof module&&module.exports?module.exports=t():e.ReconnectingWebSocket=t()}(this,function(){function e(t,n,r){function o(e,t){var n;try{n=new CustomEvent(e,{detail:t,bubbles:!1,cancelable:!1})}catch(r){n=document.createEvent("CustomEvent"),n.initCustomEvent(e,!1,!1,t)}return n}var i={debug:!1,automaticOpen:!0,reconnectInterval:1e3,maxReconnectInterval:3e4,reconnectDecay:1.5,timeoutInterval:2e3,maxReconnectAttempts:null,binaryType:"blob"};r||(r={});for(var a in i)"undefined"!=typeof r[a]?this[a]=r[a]:this[a]=i[a];this.url=t,this.reconnectAttempts=0,this.readyState=WebSocket.CONNECTING,this.protocol=null;var s,c=this,u=!1,h=!1,l=document.createElement("div");l.addEventListener("open",function(e){c.onopen(e)}),l.addEventListener("close",function(e){c.onclose(e)}),l.addEventListener("connecting",function(e){c.onconnecting(e)}),l.addEventListener("message",function(e){c.onmessage(e)}),l.addEventListener("error",function(e){c.onerror(e)}),this.addEventListener=l.addEventListener.bind(l),this.removeEventListener=l.removeEventListener.bind(l),this.dispatchEvent=l.dispatchEvent.bind(l),this.open=function(t){if(s=new WebSocket(c.url,n||[]),s.binaryType=this.binaryType,t){if(this.maxReconnectAttempts&&this.reconnectAttempts>this.maxReconnectAttempts)return}else l.dispatchEvent(o("connecting",{})),this.reconnectAttempts=0;(c.debug||e.debugAll)&&console.log("ReconnectingWebSocket","attempt-connect",c.url);var r=s,i=setTimeout(function(){(c.debug||e.debugAll)&&console.log("ReconnectingWebSocket","connection-timeout",c.url),h=!0,r.close(),h=!1},c.timeoutInterval);s.onopen=function(n){clearTimeout(i),(c.debug||e.debugAll)&&console.log("ReconnectingWebSocket","onopen",c.url),c.protocol=s.protocol,c.readyState=WebSocket.OPEN,c.reconnectAttempts=0;var r=o("open",n);r.isReconnect=t,t=!1,l.dispatchEvent(r)},s.onclose=function(n){if(clearTimeout(i),s=null,u)c.readyState=WebSocket.CLOSED,l.dispatchEvent(o("close",n));else{c.readyState=WebSocket.CONNECTING;var r=o("connecting",n);r.code=n.code,r.reason=n.reason,r.wasClean=n.wasClean,l.dispatchEvent(r),t||h||((c.debug||e.debugAll)&&console.log("ReconnectingWebSocket","onclose",c.url),l.dispatchEvent(o("close",n)));var i=c.reconnectInterval*Math.pow(c.reconnectDecay,c.reconnectAttempts);setTimeout(function(){c.reconnectAttempts++,c.open(!0)},i>c.maxReconnectInterval?c.maxReconnectInterval:i)}},s.onmessage=function(t){(c.debug||e.debugAll)&&console.log("ReconnectingWebSocket","onmessage",c.url,t.data);var n=o("message",t);n.data=t.data,l.dispatchEvent(n)},s.onerror=function(t){(c.debug||e.debugAll)&&console.log("ReconnectingWebSocket","onerror",c.url,t),l.dispatchEvent(o("error",t))}},1==this.automaticOpen&&this.open(!1),this.send=function(t){if(s)return(c.debug||e.debugAll)&&console.log("ReconnectingWebSocket","send",c.url,t),s.send(t);throw"INVALID_STATE_ERR : Pausing to reconnect websocket"},this.close=function(e,t){"undefined"==typeof e&&(e=1e3),u=!0,s&&s.close(e,t)},this.refresh=function(){s&&s.close()}}if("WebSocket"in window)return e.prototype.onopen=function(e){},e.prototype.onclose=function(e){},e.prototype.onconnecting=function(e){},e.prototype.onmessage=function(e){},e.prototype.onerror=function(e){},e.debugAll=!1,e.CONNECTING=WebSocket.CONNECTING,e.OPEN=WebSocket.OPEN,e.CLOSING=WebSocket.CLOSING,e.CLOSED=WebSocket.CLOSED,e}),function(e){function t(){}t.prototype={on:function(e,t,n){var r=this.e||(this.e={});return(r[e]||(r[e]=[])).push({fn:t,ctx:n}),this},once:function(e,t,n){function r(){o.off(e,r),t.apply(n,arguments)}var o=this;return r._=t,this.on(e,r,n)},emit:function(e){var t=[].slice.call(arguments,1),n=((this.e||(this.e={}))[e]||[]).slice(),r=0,o=n.length;for(r;o>r;r++)n[r].fn.apply(n[r].ctx,t);return this},off:function(e,t){var n=this.e||(this.e={}),r=n[e],o=[];if(r&&t)for(var i=0,a=r.length;a>i;i++)r[i].fn!==t&&r[i].fn._!==t&&o.push(r[i]);return o.length?n[e]=o:delete n[e],this}},e.TinyEmitter=t}(window),function(e,t){"use strict";function n(){var e=sessionStorage.getItem("RDBHOST_CREDENTIALS_CACHE");return e?JSON.parse(e):{}}function r(e){var t=JSON.stringify(e);sessionStorage.setItem("RDBHOST_CREDENTIALS_CACHE",t)}function o(){return new Promise(function(e,t){var n=document.getElementById("RDBHOST-SQL-INLINE-ID");if(!n)return t(new Error("no inline sql found"));try{var r=n.textContent,o=JSON.parse(r)}catch(i){return console.log("handle_inline_sql error "+i.message),t(i)}if("OK"==o.status[1])return e(o);if("rdb10"===o.error[0]){var a=n.getAttribute("data-sql"),s=n.getAttribute("data-role");if("p"===s.substr(0,1)){var c=B().query(a).go();c.then(function(t){e(t)})["catch"](function(e){t(e)})}}else t(new Error(o.error.join(" ")))})}function i(e){Rdbhost.loader=te=function(t,n){e.script(t).wait(function(){n()})}}function a(e,t,n){var r=e.querySelector(t);r&&(~t.indexOf("span.")?r.textContent=n||"":r.value=n||"")}function s(e,t){var n=t.error,r=t.notice,o=t.sql,i=t.email,s=t.role,c=a.bind(null,e);c("span.error",n||""),c("span.notice",r||""),c("span.sql",o||""),c("input[name='password']",""),c("input[name='role']",s||""),c("input[name='email']",i||"")}function c(e,t){var o,i=a.bind(null,e),s=(o=e.querySelector("input[name='email']"))?o.value:"",c=(o=e.querySelector("input[name='role']"))?o.value:"",u=(o=e.querySelector("input[name='password']"))?o.value:"";if(s.length||c.length){if(u.length){var h=n();return s&&(h.email=s),c&&(h.role=c),r(h),t([s||c,u]),!0}return i("span.error","provide a password"),!1}return i("span.error","provide an email address"),!1}function u(e,t){return t(),!0}function h(e,t,r,o){var i=n(),a=_.extend({},o,{email:i.email,role:i.role});return l(e,t,r,a)}function l(e,t,n,r){function o(e){return i.contains(e.target)?!0:(e.stopImmediatePropagation(),e.stopPropagation(),e.preventDefault(),!1)}r.error,r.sql,r.notice;if(ee)return new Promise(function(o,i){V.once(re.formcleared,function(){o(l(e,t,n,r))})});var i=document.createElement("div");i.innerHTML=t;var a=i.firstElementChild.attributes.id.value,s=i.getElementsByTagName("style")[0];if(s.parentNode.removeChild(s),document.getElementById(a))throw new Error("Element ~i in dom already".replace("~i",a));return document.body.appendChild(i),document.head.appendChild(s),ee=!0,V.emit(re.formdisplayed,[r.notice]),document.body.addEventListener("click",o,!0),new Promise(function(t,c){function u(n){n.stopPropagation(),n.preventDefault(),e(l,t)&&(document.body.removeChild(i),document.head.removeChild(s),document.body.removeEventListener("click",o,!0),ee=!1,V.emit(re.formcleared,r.notice))}function h(e){e.stopPropagation(),e.preventDefault(),document.body.removeChild(i),document.head.removeChild(s),document.body.removeEventListener("click",o,!0),ee=!1,V.emit(re.formcleared,r.notice),c(new Error("authorization dialog cancelled"))}var l=document.getElementById(a);n(l,r),l.querySelector("form").addEventListener("submit",u),l.querySelector(".cancel").addEventListener("click",h)})}function d(e,t){var n="000000000"+t;return e.substr(0,1).toLowerCase()+n.substr(n.length-10,10)}function f(e,t){function n(e){delete r[e],delete r[e+"_to"]}var r=se.authorization_cache;e+"_to"in r&&n(e);var o=setTimeout(function(){n(e)},27e5);t?(r[e]=t,r[e+"_to"]=o):n(e)}function p(e,t,n){var r=t&&_.isNumber(t);M=r?e:"www.rdbhost.com",Q=r?t:e,F=(r?n:t)||"https://"+M+"/vendor/rdbhost/"+Rdbhost.version+"/lib/partials/"}function m(e){if(!Q)throw new Error("account not set with connect method");if(Y[e])throw new Error("connection already established for "+e);var t=d(e,Q),n=!1;return Y[e]=new ReconnectingWebSocket("wss://"+M+"/wsdb/"+t,null,{debug:U}),Y[e].onopen=function(){n=!0,V.emit(re.connectionmade,e,Q),V.emit(re.connectionmade+":"+e,e,Q)},Y[e].onclose=function(){V.emit(re.connectionclosed,e,Q),V.emit(re.connectionclosed+":"+e,e,Q)},Y[e].onerror=function(){n?(V.emit(re.connectionerror,e,Q),V.emit(re.connectionerror+":"+e,e,Q)):V.emit(re.connectionopenfail,e,Q)},Y[e].onmessage=function(t){b(e,t.data)},Y[e]}function v(e,t){for(var n in Y)Y.hasOwnProperty(n)&&(Y[n].close(e,t),delete Y[n]);se.authorization_cache={},$={},r({})}function b(e,t){var n,r,o,i=JSON.parse(t),a=i["request-id"],s=Z[a];if(a&&e!==a.substr(0,e.length))throw new Error("inconsistency between role ~r and reqId ~i".replace("~r",e).replace("~i",a));if(s)n=s[0],r=s[1],o=s[2],"error"===i.status[0]?(g(i.error),r(new Error("~1 ~2".replace("~1",i.error[0]).replace("~2",i.error[1])))):(_.each(o.result_hooks,function(e){e(i)}),n(Promise.resolve(i))),delete Z[a];else if(a)console.log("Bad message request-id "+a);else if("notify"===i.status[0]){var c=i.payload,u=i.channel;"rdbhost_ftp_channel"===u.substr(0,19)?(V.emit(re.reloadrequest,u,c),V.emit(re.reloadrequest+":"+u,u,c)):(V.emit(re.notifyreceived,u,c),V.emit(re.notifyreceived+":"+u,u,c))}else"keep-alive"===i.status[0]&&console.log("keep-alive received")}function g(e){var t=e[0],n=e[1];V.emit(re.databaseerror,t,n),V.emit(re.databaseerror+":"+t,t,n),V.emit(re.databaseerror+":"+t.substr(0,2),t,n)}function w(e){var t=e[0],n=e[1];V.emit(re.databaseusererror,t,n),V.emit(re.databaseusererror+":"+t,t,n),V.emit(re.databaseusererror+":"+t.substr(0,2),t,n)}function y(e){if(!e.result_sets&&e.records){var t=e.records;e.result_sets=[t],delete e.records}}function E(e){var t=e.result_sets;if(t.length<2)throw new Error("invalid result set collection provided to strip_listen");t.splice(0,1),t.splice(t.length-2,2)}function q(e,t,n,r){var o=k(e);return o.then(function(e){return l(t,e,n,r)})}function S(e,t,n,r){var o=this,i=k(e+"_auth");return i.then(function(e){return h(c,e,s,{error:t,sql:n,notice:r})})["catch"](function(e){throw e}).then(function(t){var i=t[0],a=t[1],s="auth"===e?T(Q,e,a):L(Q,i,a);return s["catch"](function(t){if("bad input. "===t.message.substr(0,11))return S.call(o,e,"fix input",n,r);if("bad email/p"===t.message.substr(0,11))return S.call(o,e,"bad email/pass combo",n,r);throw t})})}function O(){var e=_.findIndex(this.request_hooks,function(e){return"listen"===e.label});if(e>=0&&this.repeatCt&&this.repeatCt>1)throw new Error("listen and repeat cannot be used on same request");var t=this;_.each(this.request_hooks,function(e){e(t)})}function C(){O.call(this);var e=this.formData;e.append("q",this.qPlus||this.q),delete this.qPlus,this.hasOwnProperty("repeatCt")&&e.append("repeat",this.repeatCt),this.hasOwnProperty("mode")&&e.append("mode",this.mode),"super"===this.role&&this.authorization_cache["super"]&&e.append("authcode",this.authorization_cache["super"]),"preauth"===this.role&&this.authorization_cache.preauth&&e.append("super-authcode",this.authorization_cache.preauth),"auth"===this.role&&this.authorization_cache.preauth&&(e.append("super-authcode",this.authorization_cache.preauth),e.append("authcode",this.authorization_cache.auth)),e.append("format","json-easy");var t=d(this.role,Q),n="https://"+M+"/db/"+t;return[n,e]}function P(){O.call(this);var e={q:this.qPlus||this.q,args:this.args,namedParams:this.namedParams,"request-id":this.reqId};return delete this.qPlus,this.hasOwnProperty("repeatCt")&&(e.repeat=this.repeatCt),this.hasOwnProperty("mode")&&(e.mode=this.mode),"super"===this.role?e.authcode=this.authorization_cache["super"]:"preauth"===this.role?(e["super-authcode"]=this.authorization_cache.preauth,e.authcode="-"):"auth"===this.role&&(e["super-authcode"]=this.authorization_cache.preauth,e.authcode=this.authorization_cache.auth),JSON.stringify(e)}function N(){return"super"===this.role?!!this.authorization_cache["super"]:"preauth"===this.role?!!this.authorization_cache.preauth:"auth"===this.role?!(!this.authorization_cache.preauth||!this.authorization_cache.auth):!1}function k(e){if(e in $)return Promise.resolve($[e]);var t=F+e+".tpl.html",n=fetch(t);return n.then(function(n){if(!n.ok)throw new Error("page ~p not found.".replace("~p",t));var r=n.text();return r.then(function(t){return $[e]=t,$[e]})},function(e){throw e})}function I(e){var t=this;return new Promise(function(n,r){var o=e.call(t),i=o[0],a=o[1],s=fetch(i,{method:"post",body:a});s.then(function(e){if(e.ok){var o=e.json();o.then(function(e){"error"===e.status[0]?(g(e.error),r(new Error("~1 ~2".replace("~1",e.error[0]).replace("~2",e.error[1])))):(_.each(t.result_hooks,function(t){t(e)}),n(e))})}else r(new Error("Status: "+e.status+" "+e.statusText))})["catch"](function(e){r(e)})})}function A(e){function t(){var t=e.call(n);return new Promise(function(e,r){n.conn.send(t),Z[n.reqId]=[e,r,n]})}var n=this;return Y[n.role]&&Y[n.role].readyState===ne.OPEN?t():new Promise(function(e,r){V.once(re.connectionmade+":"+n.role,function(){e(t())})})}function R(e,t){function n(){if(!r.q)throw new Error("no query was provided");if(r.isDone)throw new Error("request has already been run. use clone to rerun it.");return r.formData?e.call(r):t.call(r)}var r=this;if(Rdbhost.paranoid_confirm&&N.call(this)){var o=k("any_confirm"),i=r.role.substr(0,1).toUpperCase()+r.role.substr(1);return o.then(function(e){return h(u,e,s,{error:"",sql:r.q,notice:i})})["catch"](function(e){throw e}).then(function(){return n()})}return n()}function x(e){_.extend(se,e)}function L(e,t,n){var r="https://"+M+"/acct/login/0"+d("reader",e).substr(1),o=new FormData;o.append("arg:email",t),o.append("arg:password",n);var i=fetch(r,{method:"post",body:o});return i.then(function(e){return e.json().then(function(e){if(e.error)throw new Error(e.error[1]);for(var t in e.records.rows){var n=e.records.rows[t];if("s"===n.role.substr(0,1))return n}throw new Error("super not found in login records")})})}function T(e,t,n){var r=d("auth",e),o="https://"+M+"/acct/authlogin/0"+r.substr(1),i=new FormData;i.append("arg:role",r),i.append("arg:password",n);var a=fetch(o,{method:"post",body:i});return a.then(function(e){return e.json().then(function(e){if(e.error)throw new Error(e.error[1]);for(var t in e.records.rows){var n=e.records.rows[t];if("a"===n.role.substr(0,1))return n}throw new Error("auth not found in login records")})})}function j(e,t){var n=this,r=e.call(n,t);return r["catch"](function(r){if("rdb12"===r.message.substr(0,5))return oe.call(n,n.q,"Approve Super Query").then(function(r){return f("super",r.authcode),e.call(n,t)});throw r})}function D(e,t){return e.call(this,t)}function z(e,t){var n=this,r=e.call(n,t);return r["catch"](function(r){if("rdb10"===r.message.substr(0,5))return ie.call(n,n.q,"Authorize Whitelisting of Query").then(function(r){return f("preauth",r.authcode),e.call(n,t)});throw r})}function W(e,t){var n=this,r=e.call(n,t);return r["catch"](function(r){if("rdb12"===r.message.substr(0,5))return ae.call(n,n.q,"Approve Auth Query").then(function(r){return f("auth",r.authcode),e.call(n,t)})["catch"](function(r){if("rdb10"===r.message.substr(0,5))return ie.call(n,n.q,"Authorize Whitelisting of Query").then(function(r){return f("preauth",r.authcode),e.call(n,t)});throw r});throw r})}function B(){var e=Object.create(se),t=z.bind(e,A,P),n=z.bind(e,I,C);return e.go=R.bind(e,n,t),e.init("preauth")}function G(e){var t=Object.create(se),n=W.bind(t,A,P),r=W.bind(t,I,C);return t.go=R.bind(t,r,n),e&&f("auth",e),t.init("auth")}function H(e){var t=Object.create(se),n=j.bind(t,A,P),r=j.bind(t,I,C);return t.go=R.bind(t,r,n),e&&f("super",e),t.init("super")}function J(){var e=Object.create(se),t=D.bind(e,A,P),n=D.bind(e,I,C);return e.go=R.bind(e,n,t),e.init("reader")}var M,Q,F,K="latest",U=!0,V=new TinyEmitter,Y={},X=1,Z={},$={},ee=!1,te=function(e,t){throw new Error("no loader defined")},ne={CONNECTING:0,OPEN:1,CLOSING:2,CLOSED:3},re={connectionmade:"connection-opened",connectionclosed:"connection-closed",connectionerror:"connection-error",connectionopenfail:"connection-open-failed",databaseerror:"database-error",databaseusererror:"database-user-error",notifyreceived:"notify-received",reloadrequest:"reload-request",formdisplayed:"form-displayed",formcleared:"form-cleared"},oe=function(e,t){return S.call(this,"super","",e,t)},ie=function(e,t){return S.call(this,"preauth","",e,t)},ae=function(e,t){return S.call(this,"auth","",e,t)},se={authorization_cache:{},conn:t,init:function(e){if(["preauth","auth","reader","super"].indexOf(e)<0)throw new Error("invalid role "+e+" provided to init");return this.role=e,this.reqId=e+X++,this.isDone=!1,this.conn=Y[e]||m(e),this.result_hooks=[y],this.request_hooks=[],this},proxy:function(e){return this.mode=e,this},query:function(e){return this.q=e,this},params:function(e,t){if(delete this.args,delete this.namedParams,!e&&!t)return this;if("object"!=typeof e)throw new Error("params must be object or array");if(t&&"object"!=typeof t)throw new Error("params must be object or array");if(this.formData)throw new Error("params and FormData cannot be used both in one request");if("number"==typeof e.length?this.args=e:this.namedParams=e,t)if("number"==typeof t.length){if("args"in this)throw new Error("two arrays were provided to params");this.args=t}else{if("namedParams"in this)throw new Error("two objects were provided to params");this.namedParams=t}return this},form_data:function(e){if(this.hasOwnProperty("args")&&this.args.length>0||this.hasOwnProperty("namedParams")&&Object.keys(this.namedParams).length>0)throw new Error("formData cannot be combined with params in same request.");return this.formData=e,this},listen:function(e){if(e.indexOf('"')>-1)throw new Error("channel name cannot include quotes");var t=function(t){var n=t.qPlus||t.q,r=['LISTEN "~1"'.replace("~1",e),n,"COMMIT; BEGIN;"];t.qPlus=r.join(";\n")};return t.label="listen",this.request_hooks.push(t),this.result_hooks.push(E),this},repeat:function(e){try{e=Number(e)}catch(t){throw new Error("provide number value to repeat method.")}return this.repeatCt=1,e>1&&(this.repeatCt=e),this},get_data:function(){return this.go()["catch"](function(e){var t=e.message.indexOf(" "),n=t>=0?t:e.message.length,r=e.message.substr(0,n),o=e.message.substr(n+1);throw w([r,o]),e})},clone:function(){var e=Rdbhost[this.role]();for(var t in this)!this.hasOwnProperty(t)||["reqId","conn","role","isDone","qPlus"].indexOf(t)>=0||"function"==typeof this[t]||(_.isArray(this[t])?e[t]=this[t].slice(0):_.isObject(this[t])?e[t]=_.extend({},this[t]):e[t]=this[t]);return e}};V.on(re.connectionopenfail,function(t){var n=fetch("//"+M+"/acct/corstest/"+Q);n.then(function(t){t.json().then(function(t){"not-ok"===t.status?(console.log("This origin ("+e.location.origin+") is not a CORS-allowed origin for account "+Q+"."),console.log("Allowed origins (obscured) are "+t.origins.join(", "))):console.log("Your connection failed, but your domain is CORS-allowed.")})})}),e.Rdbhost=_.extend(e.Rdbhost||{},{on:V.on.bind(V),off:V.off.bind(V),once:V.once.bind(V),connect:p,disconnect:v,preauth:B,auth:G,"super":H,reader:J,inline_sql:o,use_labjs_loader:i,loader:te,extend_request_prototype:x,version:K,account_number:function(){return Q},host:function(){return M},paranoid_confirm:!1,show_form:q})}(window);