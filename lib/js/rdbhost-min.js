!function(e,r){"use strict";function t(){return new Promise(function(e,r){var t=document.getElementById("RDBHOST-SQL-INLINE-ID");if(!t)return r(new Error("no inline sql found"));try{var n=t.textContent,o=JSON.parse(n)}catch(i){return console.log("handle_inline_sql error "+i.message),r(i)}if("OK"==o.status[1])return e(o);if("rdb10"===o.error[0]){var a=t.getAttribute("data-sql"),s=t.getAttribute("data-role");if("p"===s.substr(0,1)){var u=S().query(a).go();u.then(function(r){e(r)})["catch"](function(e){r(e)})}}else r(new Error(o.error.join(" ")))})}function n(e,r,t,o){if(J)return new Promise(function(i,a){T.once(H.formcleared,function(){i(n(e,r,t,o))})});var i=document.createElement("div");i.innerHTML=e;var a=i.firstElementChild.attributes.id.value;return document.getElementById(a)||document.body.appendChild(i),J=!0,new Promise(function(e,n){function s(e,r){var t=h.querySelector(e);t&&(~e.indexOf("span.")?t.textContent=r||"":t.value=r||"")}function u(r){var t;r.stopPropagation(),r.preventDefault();var n=(t=h.querySelector("input[name='email']"))?t.value:"",a=(t=h.querySelector("input[name='role']"))?t.value:"",u=(t=h.querySelector("input[name='password']"))?t.value:"";n.length||a.length?u.length?(document.body.removeChild(i),n&&(G.email=n),a&&(G.role=a),e([n||a,u]),J=!1,T.emit(H.formcleared,o)):s("span.error","provide a password"):s("span.error","provide an email address")}function c(e){e.stopPropagation(),e.preventDefault(),document.body.removeChild(i),n(new Error("authorization dialog cancelled")),J=!1,T.emit(H.formcleared,o)}var h=document.getElementById(a);s("span.error",r||""),s("span.notice",o||""),s("span.sql",t||""),s("input[name='email']",G.email||""),s("input[name='password']",""),s("input[name='role']",G.role||""),h.querySelector("form").addEventListener("submit",u),h.querySelector(".cancel").addEventListener("click",c)})}function o(e,r){var t="000000000"+r;return e.substr(0,1).toLowerCase()+t.substr(t.length-10,10)}function i(e,r){function t(e){delete n[e],delete n[e+"_to"]}var n=U.authorization_cache;e+"_to"in n&&t(e);var o=setTimeout(function(){t(e)},27e5);r?(n[e]=r,n[e+"_to"]=o):t(e)}function a(e,r){N=r?e:"www.rdbhost.com",x=r?r:e,z="http://devdemos.noservercoding.com/rdb2js/lib/partials/"}function s(e){if(!x)throw new Error("account not set with connect method");if(B[e])throw new Error("connection already established for "+e);var r=o(e,x);return B[e]=new ReconnectingWebSocket("wss://"+N+"/wsdb/"+r,null,{debug:!0}),B[e].onopen=function(){T.emit(H.connectionmade,e,x),T.emit(H.connectionmade+":"+e,e,x)},B[e].onclose=function(){T.emit(H.connectionclosed,e,x),T.emit(H.connectionclosed+":"+e,e,x)},B[e].onerror=function(){T.emit(H.connectionerror,e,x),T.emit(H.connectionerror+":"+e,e,x)},B[e].onmessage=function(r){c(e,r.data)},B[e]}function u(e,r){for(var t in B)B.hasOwnProperty(t)&&(B[t].close(e,r),delete B[t]);U.authorization_cache={}}function c(e,r){var t,n,o,i=JSON.parse(r),a=i["request-id"],s=A[a];if(a&&e!==a.substr(0,e.length))throw new Error("inconsistency between role ~r and reqId ~i".replace("~r",e).replace("~i",a));if(s)t=s[0],n=s[1],o=s[2],"error"===i.status[0]?(h(i.error),n(new Error("error ~1 ~2".replace("~1",i.error[0]).replace("~2",i.error[1])))):(_.each(o.result_hooks,function(e){e(i)}),t(Promise.resolve(i))),delete A[a];else if(a)console.log("Bad message request-id "+a);else if("notify"===i.status[0]){var u=i.payload,c=i.channel;"rdbhost_ftp_channel"===c.substr(0,19)?(T.emit(H.reloadrequest,c,u),T.emit(H.reloadrequest+":"+c,c,u)):(T.emit(H.notifyreceived,c,u),T.emit(H.notifyreceived+":"+c,c,u))}}function h(e){var r=e[0],t=e[1];T.emit(H.databaseerror,r,t),T.emit(H.databaseerror+":"+r,r,t),T.emit(H.databaseerror+":"+r.substr(0,2),r,t)}function l(e){if(!e.result_sets&&e.records){var r=e.records;e.result_sets=[r],delete e.records}}function d(e){var r=e.result_sets;if(r.length<2)throw new Error("invalid result set collection provided to strip_listen");r.splice(0,1),r.splice(r.length-2,2)}function f(e,r,t){var o=this,i=b(e+"_auth");return i.then(function(e){return n(e,r,null,t)})["catch"](function(e){throw e}).then(function(r){var n=r[0],i=r[1],a="auth"===e?E(acct_number,e,i):q(acct_number,n,i);return a["catch"](function(r){if("bad input. "===r.message.substr(0,11))return f.call(o,e,"fix input",t);if("bad email/p"===r.message.substr(0,11))return f.call(o,e,"bad email/pass combo",t);throw r})})}function p(){if(this.request_hooks.length&&this.repeatCt&&this.repeatCt>1){var e=_.filter(this.request_hooks,function(e){return"listen"===e.label});if(e.length)throw new Error("listen and repeat cannot be used on same request")}var r=this;_.each(this.request_hooks,function(e){e(r)})}function m(){p.call(this);var e=this.formData;e.append("q",this.qPlus||this.q),delete this.qPlus,this.hasOwnProperty("repeatCt")&&e.append("repeat",this.repeatCt),this.hasOwnProperty("mode")&&e.append("mode",this.mode),"super"===this.role&&this.authorization_cache["super"]&&e.append("authcode",this.authorization_cache["super"]),"preauth"===this.role&&this.authorization_cache.preauth&&e.append("super-authcode",this.authorization_cache.preauth),e.append("format","json-easy");var r=o(this.role,x),t="https://"+N+"/db/"+r;return[t,e]}function w(){p.call(this);var e={q:this.qPlus||this.q,args:this.args,namedParams:this.namedParams,"request-id":this.reqId};return delete this.qPlus,this.hasOwnProperty("repeatCt")&&(e.repeat=this.repeatCt),this.hasOwnProperty("mode")&&(e.mode=this.mode),"super"===this.role?e.authcode=this.authorization_cache["super"]:"preauth"===this.role?(e["super-authcode"]=this.authorization_cache.preauth,e.authcode="-"):"auth"===this.role&&(e["super-authcode"]=this.authorization_cache.preauth,e.authcode=this.authorization_cache.auth),JSON.stringify(e)}function b(e){if(e in F)return Promise.resolve(F[e]);var r=z+e+".tpl.html",t=fetch(r);return t.then(function(t){if(!t.ok)throw new Error("page ~p not found.".replace("~p",r));var n=t.text();return n.then(function(r){return F[e]=r,F[e]})},function(e){throw e})}function v(e){var r=this;return new Promise(function(t,n){var o=e.call(r),i=o[0],a=o[1],s=fetch(i,{method:"post",body:a});s.then(function(e){if(e.ok){var o=e.json();o.then(function(e){"error"===e.status[0]?(h(e.error),n(new Error("error ~1 ~2".replace("~1",e.error[0]).replace("~2",e.error[1])))):(_.each(r.result_hooks,function(r){r(e)}),t(e))})}else n(new Error("Status: "+e.status+" "+e.statusText))})["catch"](function(e){n(e)})})}function g(e){function r(){var r=e.call(t);return new Promise(function(e,n){t.conn.send(r),A[t.reqId]=[e,n,t]})}var t=this;return B[t.role]&&B[t.role].readyState===M.OPEN?r():new Promise(function(e,n){T.once(H.connectionmade+":"+t.role,function(){e(r())})})}function y(e,r){if(!this.q)throw new Error("no query was provided");if(this.isDone)throw new Error("request has already been run. use clone to rerun it.");return this.formData?e.call(this):r.call(this)}function q(e,r,t){var n="https://"+N+"/acct/login/0"+o("reader",e).substr(1),i=new FormData;i.append("arg:email",r),i.append("arg:password",t);var a=fetch(n,{method:"post",body:i});return a.then(function(e){return e.json().then(function(e){if(e.error)throw new Error(e.error[1]);for(var r in e.records.rows){var t=e.records.rows[r];if("s"===t.role.substr(0,1))return t}throw new Error("super not found in login records")})})}function E(e,r,t){var n=o("auth",e),i="https://"+N+"/acct/authlogin/0"+n.substr(1),a=new FormData;a.append("arg:role",n),a.append("arg:password",t);var s=fetch(i,{method:"post",body:a});return s.then(function(e){return e.json().then(function(e){if(e.error)throw new Error(e.error[1]);for(var r in e.records.rows){var t=e.records.rows[r];if("a"===t.role.substr(0,1))return t}throw new Error("auth not found in login records")})})}function P(e,r){var t=this,n=e.call(t,r);return n["catch"](function(n){if("error rdb12"===n.message.substr(0,11))return K.call(t).then(function(n){return i("super",n.authcode),e.call(t,r)});throw n})}function O(e,r){return e.call(this,r)}function C(e,r){var t=this,n=e.call(t,r);return n["catch"](function(n){if("error rdb10"===n.message.substr(0,11))return Q.call(t,"").then(function(n){return i("preauth",n.authcode),e.call(t,r)});throw n})}function j(e,r){var t=this,n=e.call(t,r);return n["catch"](function(n){if("error rdb12"===n.message.substr(0,11))return W.call(t).then(function(n){return i("auth",n.authcode),e.call(t,r)})["catch"](function(n){if("error rdb10"===n.message.substr(0,11))return Q.call(t,"").then(function(n){return i("preauth",n.authcode),e.call(t,r)});throw n});throw n})}function S(){var e=Object.create(U),r=C.bind(e,g,w),t=C.bind(e,v,m);return e.go=y.bind(e,t,r),e.init("preauth")}function D(e){var r=Object.create(U),t=j.bind(r,g,w),n=j.bind(r,v,m);return r.go=y.bind(r,n,t),e&&i("auth",e),r.init("auth")}function I(e){var r=Object.create(U),t=P.bind(r,g,w),n=P.bind(r,v,m);return r.go=y.bind(r,n,t),e&&i("super",e),r.init("super")}function k(){var e=Object.create(U),r=O.bind(e,g,w),t=O.bind(e,v,m);return e.go=y.bind(e,t,r),e.init("reader")}var N,x,z,L="2.0.0",T=new TinyEmitter,B={},R=1,A={},F={},G={},J=!1,M={CONNECTING:0,OPEN:1,CLOSING:2,CLOSED:3},H={connectionmade:"connection-opened",connectionclosed:"connection-closed",connectionerror:"connection-error",databaseerror:"database-error",notifyreceived:"notify-received",reloadrequest:"reload-request",formcleared:"form-cleared"},K=function(e,r){return f.call(this,"super",e,r)},Q=function(e,r){return f.call(this,"preauth",e,r)},W=function(e,r){return f.call(this,"auth",e,r)},U={authorization_cache:{},conn:r,init:function(e){if(["preauth","auth","reader","super"].indexOf(e)<0)throw new Error("invalid role "+e+" provided to init");return this.role=e,this.reqId=e+R++,this.isDone=!1,this.conn=B[e]||s(e),this.result_hooks=[l],this.request_hooks=[],this},proxy:function(e){return this.mode=e,this},query:function(e){return this.q=e,this},params:function(e,r){if(delete this.args,delete this.namedParams,"object"!=typeof e)throw new Error("params must be object or array");if(r&&"object"!=typeof r)throw new Error("params must be object or array");if(this.formData)throw new Error("params and FormData cannot be used both in one request");if("number"==typeof e.length?this.args=e:this.namedParams=e,r)if("number"==typeof r.length){if("args"in this)throw new Error("two arrays were provided to params");this.args=r}else{if("namedParams"in this)throw new Error("two objects were provided to params");this.namedParams=r}return this},form_data:function(e){if(this.hasOwnProperty("args")&&this.args.length>0||this.hasOwnProperty("namedParams")&&Object.keys(this.namedParams).length>0)throw new Error("formData cannot be combined with params in same request.");return this.formData=e,this},listen:function(e){if(e.indexOf('"')>-1)throw new Error("channel name cannot include quotes");var r=function(r){var t=['LISTEN "~1"'.replace("~1",e),r.q,"COMMIT; BEGIN;"];r.qPlus=t.join(";\n")};return r.label="listen",this.request_hooks.push(r),this.result_hooks.push(d),this},repeat:function(e){try{e=Number(e)}catch(r){throw new Error("provide number value to repeat method.")}return e>1&&(this.repeatCt=e),this},clone:function(){var e=Rdbhost[this.role]();for(var r in this)!this.hasOwnProperty(r)||["reqId","conn","role","isDone","qPlus"].indexOf(r)>=0||"function"==typeof this[r]||(_.isArray(this[r])?e[r]=this[r].slice(0):_.isObject(this[r])?e[r]=_.extend({},this[r]):e[r]=this[r]);return e}};e.Rdbhost=_.extend(e.Rdbhost||{},{on:T.on.bind(T),off:T.off.bind(T),once:T.once.bind(T),connect:a,disconnect:u,preauth:S,auth:D,"super":I,reader:k,inline_sql:t,version:L})}(window);