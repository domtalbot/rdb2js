!function(e,t){"use strict";function r(){return new Promise(function(e,t){var r=document.getElementById("RDBHOST-SQL-INLINE-ID");if(!r)return t(new Error("no inline sql found"));try{var n=r.textContent,o=JSON.parse(n)}catch(i){return console.log("handle_inline_sql error "+i.message),t(i)}if("OK"==o.status[1])return e(o);if("rdb10"===o.error[0]){var a=r.getAttribute("data-sql"),s=r.getAttribute("data-role");if("p"===s.substr(0,1)){var u=N().query(a).go();u.then(function(t){e(t)})["catch"](function(e){t(e)})}}else t(new Error(o.error.join(" ")))})}function n(e,t,r){var n=e.querySelector(t);n&&(~t.indexOf("span.")?n.textContent=r||"":n.value=r||"")}function o(e,t,r,o,i,a){var s=n.bind(null,e);s("span.error",t||""),s("span.notice",r||""),s("span.sql",o||""),s("input[name='password']",""),s("input[name='role']",a||""),s("input[name='email']",i||"")}function i(e,t){var r,o=n.bind(null,e),i=(r=e.querySelector("input[name='email']"))?r.value:"",a=(r=e.querySelector("input[name='role']"))?r.value:"",s=(r=e.querySelector("input[name='password']"))?r.value:"";return i.length||a.length?s.length?(i&&(K.email=i),a&&(K.role=a),t([i||a,s]),!0):(o("span.error","provide a password"),!1):(o("span.error","provide an email address"),!1)}function a(e,t){return t(),!0}function s(e,t,r,n,o,i){if(Y)return new Promise(function(a,u){G.once(V.formcleared,function(){a(s(e,t,r,n,o,i))})});var a=document.createElement("div");a.innerHTML=r;var u=a.firstElementChild.attributes.id.value;return document.getElementById(u)||document.body.appendChild(a),Y=!0,new Promise(function(r,s){function c(t){t.stopPropagation(),t.preventDefault(),e(l,r)&&(document.body.removeChild(a),Y=!1,G.emit(V.formcleared,i))}function h(e){e.stopPropagation(),e.preventDefault(),document.body.removeChild(a),s(new Error("authorization dialog cancelled")),Y=!1,G.emit(V.formcleared,i)}var l=document.getElementById(u);t(l,n,i,o,K.email,K.role),l.querySelector("form").addEventListener("submit",c),l.querySelector(".cancel").addEventListener("click",h)})}function u(e,t){var r="000000000"+t;return e.substr(0,1).toLowerCase()+r.substr(r.length-10,10)}function c(e,t){function r(e){delete n[e],delete n[e+"_to"]}var n=ee.authorization_cache;e+"_to"in n&&r(e);var o=setTimeout(function(){r(e)},27e5);t?(n[e]=t,n[e+"_to"]=o):r(e)}function h(e,t,r){var n=t&&_.isNumber(t);T=n?e:"www.rdbhost.com",R=n?t:e,B=(n?r:t)||"//"+T+"/vendor/rdbhost/2.0/lib/partials/"}function l(e){if(!R)throw new Error("account not set with connect method");if(J[e])throw new Error("connection already established for "+e);var t=u(e,R),r=!1;return J[e]=new ReconnectingWebSocket("wss://"+T+"/wsdb/"+t,null,{debug:F}),J[e].onopen=function(){r=!0,G.emit(V.connectionmade,e,R),G.emit(V.connectionmade+":"+e,e,R)},J[e].onclose=function(){G.emit(V.connectionclosed,e,R),G.emit(V.connectionclosed+":"+e,e,R)},J[e].onerror=function(){r?(G.emit(V.connectionerror,e,R),G.emit(V.connectionerror+":"+e,e,R)):G.emit(V.connectionopenfail,e,R)},J[e].onmessage=function(t){f(e,t.data)},J[e]}function d(e,t){for(var r in J)J.hasOwnProperty(r)&&(J[r].close(e,t),delete J[r]);ee.authorization_cache={}}function f(e,t){var r,n,o,i=JSON.parse(t),a=i["request-id"],s=W[a];if(a&&e!==a.substr(0,e.length))throw new Error("inconsistency between role ~r and reqId ~i".replace("~r",e).replace("~i",a));if(s)r=s[0],n=s[1],o=s[2],"error"===i.status[0]?(p(i.error),n(new Error("error ~1 ~2".replace("~1",i.error[0]).replace("~2",i.error[1])))):(_.each(o.result_hooks,function(e){e(i)}),r(Promise.resolve(i))),delete W[a];else if(a)console.log("Bad message request-id "+a);else if("notify"===i.status[0]){var u=i.payload,c=i.channel;"rdbhost_ftp_channel"===c.substr(0,19)?(G.emit(V.reloadrequest,c,u),G.emit(V.reloadrequest+":"+c,c,u)):(G.emit(V.notifyreceived,c,u),G.emit(V.notifyreceived+":"+c,c,u))}else"keep-alive"===i.status[0]&&console.log("keep-alive received")}function p(e){var t=e[0],r=e[1];G.emit(V.databaseerror,t,r),G.emit(V.databaseerror+":"+t,t,r),G.emit(V.databaseerror+":"+t.substr(0,2),t,r)}function m(e){if(!e.result_sets&&e.records){var t=e.records;e.result_sets=[t],delete e.records}}function w(e){var t=e.result_sets;if(t.length<2)throw new Error("invalid result set collection provided to strip_listen");t.splice(0,1),t.splice(t.length-2,2)}function b(e,t,r,n){var a=this,u=E(e+"_auth");return u.then(function(e){return s(i,o,e,t,r,n)})["catch"](function(e){throw e}).then(function(t){var o=t[0],i=t[1],s="auth"===e?S(acct_number,e,i):z(acct_number,o,i);return s["catch"](function(t){if("bad input. "===t.message.substr(0,11))return b.call(a,e,"fix input",r,n);if("bad email/p"===t.message.substr(0,11))return b.call(a,e,"bad email/pass combo",r,n);throw t})})}function v(){if(this.request_hooks.length&&this.repeatCt&&this.repeatCt>1){var e=_.filter(this.request_hooks,function(e){return"listen"===e.label});if(e.length)throw new Error("listen and repeat cannot be used on same request")}var t=this;_.each(this.request_hooks,function(e){e(t)})}function g(){v.call(this);var e=this.formData;e.append("q",this.qPlus||this.q),delete this.qPlus,this.hasOwnProperty("repeatCt")&&e.append("repeat",this.repeatCt),this.hasOwnProperty("mode")&&e.append("mode",this.mode),"super"===this.role&&this.authorization_cache["super"]&&e.append("authcode",this.authorization_cache["super"]),"preauth"===this.role&&this.authorization_cache.preauth&&e.append("super-authcode",this.authorization_cache.preauth),"auth"===this.role&&this.authorization_cache.preauth&&(e.append("super-authcode",this.authorization_cache.preauth),e.append("authcode",this.authorization_cache.auth)),e.append("format","json-easy");var t=u(this.role,R),r="https://"+T+"/db/"+t;return[r,e]}function y(){v.call(this);var e={q:this.qPlus||this.q,args:this.args,namedParams:this.namedParams,"request-id":this.reqId};return delete this.qPlus,this.hasOwnProperty("repeatCt")&&(e.repeat=this.repeatCt),this.hasOwnProperty("mode")&&(e.mode=this.mode),"super"===this.role?e.authcode=this.authorization_cache["super"]:"preauth"===this.role?(e["super-authcode"]=this.authorization_cache.preauth,e.authcode="-"):"auth"===this.role&&(e["super-authcode"]=this.authorization_cache.preauth,e.authcode=this.authorization_cache.auth),JSON.stringify(e)}function q(){return"super"===this.role?!!this.authorization_cache["super"]:"preauth"===this.role?!!this.authorization_cache.preauth:"auth"===this.role?!(!this.authorization_cache.preauth||!this.authorization_cache.auth):!1}function E(e){if(e in H)return Promise.resolve(H[e]);var t=B+e+".tpl.html",r=fetch(t);return r.then(function(r){if(!r.ok)throw new Error("page ~p not found.".replace("~p",t));var n=r.text();return n.then(function(t){return H[e]=t,H[e]})},function(e){throw e})}function P(e){var t=this;return new Promise(function(r,n){var o=e.call(t),i=o[0],a=o[1],s=fetch(i,{method:"post",body:a});s.then(function(e){if(e.ok){var o=e.json();o.then(function(e){"error"===e.status[0]?(p(e.error),n(new Error("error ~1 ~2".replace("~1",e.error[0]).replace("~2",e.error[1])))):(_.each(t.result_hooks,function(t){t(e)}),r(e))})}else n(new Error("Status: "+e.status+" "+e.statusText))})["catch"](function(e){n(e)})})}function O(e){function t(){var t=e.call(r);return new Promise(function(e,n){r.conn.send(t),W[r.reqId]=[e,n,r]})}var r=this;return J[r.role]&&J[r.role].readyState===U.OPEN?t():new Promise(function(e,n){G.once(V.connectionmade+":"+r.role,function(){e(t())})})}function C(e,t){function r(){if(!n.q)throw new Error("no query was provided");if(n.isDone)throw new Error("request has already been run. use clone to rerun it.");return n.formData?e.call(n):t.call(n)}var n=this;if(Rdbhost.paranoid_confirm&&q.call(this)){var i=E(n.role+"_confirm");return i.then(function(e){return s(a,o,e,"",n.q,"")})["catch"](function(e){throw e}).then(function(){return r()})}return r()}function z(e, t, r){var n="https://"+T+"/acct/login/0"+u("reader",e).substr(1),o=new FormData;o.append("arg:email",t),o.append("arg:password",r);var i=fetch(n,{method:"post",body:o});return i.then(function(e){return e.json().then(function(e){if(e.error)throw new Error(e.error[1]);for(var t in e.records.rows){var r=e.records.rows[t];if("s"===r.role.substr(0,1))return r}throw new Error("super not found in login records")})})}function S(e,t,r){var n=u("auth",e),o="https://"+T+"/acct/authlogin/0"+n.substr(1),i=new FormData;i.append("arg:role",n),i.append("arg:password",r);var a=fetch(o,{method:"post",body:i});return a.then(function(e){return e.json().then(function(e){if(e.error)throw new Error(e.error[1]);for(var t in e.records.rows){var r=e.records.rows[t];if("a"===r.role.substr(0,1))return r}throw new Error("auth not found in login records")})})}function j(e,t){var r=this,n=e.call(r,t);return n["catch"](function(n){if("error rdb12"===n.message.substr(0,11))return X.call(r,r.q,"Approve Super Query").then(function(n){return c("super",n.authcode),e.call(r,t)});throw n})}function k(e,t){return e.call(this,t)}function D(e,t){var r=this,n=e.call(r,t);return n["catch"](function(n){if("error rdb10"===n.message.substr(0,11))return Z.call(r,r.q,"Authorize Whitelisting of Query").then(function(n){return c("preauth",n.authcode),e.call(r,t)});throw n})}function I(e,t){var r=this,n=e.call(r,t);return n["catch"](function(n){if("error rdb12"===n.message.substr(0,11))return $.call(r,r.q,"Approve Auth Query").then(function(n){return c("auth",n.authcode),e.call(r,t)})["catch"](function(n){if("error rdb10"===n.message.substr(0,11))return Z.call(r,r.q,"Authorize Whitelisting of Query").then(function(n){return c("preauth",n.authcode),e.call(r,t)});throw n});throw n})}function N(){var e=Object.create(ee),t=D.bind(e,O,y),r=D.bind(e,P,g);return e.go=C.bind(e,r,t),e.init("preauth")}function x(e){var t=Object.create(ee),r=I.bind(t,O,y),n=I.bind(t,P,g);return t.go=C.bind(t,n,r),e&&c("auth",e),t.init("auth")}function A(e){var t=Object.create(ee),r=j.bind(t,O,y),n=j.bind(t,P,g);return t.go=C.bind(t,n,r),e&&c("super",e),t.init("super")}function L(){var e=Object.create(ee),t=k.bind(e,O,y),r=k.bind(e,P,g);return e.go=C.bind(e,r,t),e.init("reader")}var T,R,B,Q="2.0.0",F=!0,G=new TinyEmitter,J={},M=1,W={},H={},K={},Y=!1,U={CONNECTING:0,OPEN:1,CLOSING:2,CLOSED:3},V={connectionmade:"connection-opened",connectionclosed:"connection-closed",connectionerror:"connection-error",connectionopenfail:"connection-open-failed",databaseerror:"database-error",notifyreceived:"notify-received",reloadrequest:"reload-request",formcleared:"form-cleared"},X=function(e,t){return b.call(this,"super","",e,t)},Z=function(e,t){return b.call(this,"preauth","",e,t)},$=function(e,t){return b.call(this,"auth","",e,t)},ee={authorization_cache:{},conn:t,init:function(e){if(["preauth","auth","reader","super"].indexOf(e)<0)throw new Error("invalid role "+e+" provided to init");return this.role=e,this.reqId=e+M++,this.isDone=!1,this.conn=J[e]||l(e),this.result_hooks=[m],this.request_hooks=[],this},proxy:function(e){return this.mode=e,this},query:function(e){return this.q=e,this},params:function(e,t){if(delete this.args,delete this.namedParams,!e&&!t)return this;if("object"!=typeof e)throw new Error("params must be object or array");if(t&&"object"!=typeof t)throw new Error("params must be object or array");if(this.formData)throw new Error("params and FormData cannot be used both in one request");if("number"==typeof e.length?this.args=e:this.namedParams=e,t)if("number"==typeof t.length){if("args"in this)throw new Error("two arrays were provided to params");this.args=t}else{if("namedParams"in this)throw new Error("two objects were provided to params");this.namedParams=t}return this},form_data:function(e){if(this.hasOwnProperty("args")&&this.args.length>0||this.hasOwnProperty("namedParams")&&Object.keys(this.namedParams).length>0)throw new Error("formData cannot be combined with params in same request.");return this.formData=e,this},listen:function(e){if(e.indexOf('"')>-1)throw new Error("channel name cannot include quotes");var t=function(t){var r=['LISTEN "~1"'.replace("~1",e),t.q,"COMMIT; BEGIN;"];t.qPlus=r.join(";\n")};return t.label="listen",this.request_hooks.push(t),this.result_hooks.push(w),this},repeat:function(e){try{e=Number(e)}catch(t){throw new Error("provide number value to repeat method.")}return this.repeatCt=1,e>1&&(this.repeatCt=e),this},clone:function(){var e=Rdbhost[this.role]();for(var t in this)!this.hasOwnProperty(t)||["reqId","conn","role","isDone","qPlus"].indexOf(t)>=0||"function"==typeof this[t]||(_.isArray(this[t])?e[t]=this[t].slice(0):_.isObject(this[t])?e[t]=_.extend({},this[t]):e[t]=this[t]);return e}};G.on(V.connectionopenfail,function(t){fetch("http://"+T+"/acct/corstest/"+R).then(function(t){t.json().then(function(t){"not-ok"===t.status?(console.log("This origin ("+e.location.origin+") is not a CORS-allowed origin for account "+R+"."),console.log("Allowed origins (obscured) are "+t.origins.join(", "))):console.log("Your connection failed, but your domain is CORS-allowed.")})})}),e.Rdbhost=_.extend(e.Rdbhost||{},{on:G.on.bind(G),off:G.off.bind(G),once:G.once.bind(G),connect:h,disconnect:d,preauth:N,auth:x,"super":A,reader:L,inline_sql:r,version:Q,paranoid_confirm:!1})}(window);